<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Form POS + Cetak Dot Matrix (Final)</title>
  <script src="https://unpkg.com/jsprintmanager"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1cm; }
    table { width: 100%; border-collapse: collapse; font-size: 11pt; }
    th, td { border: 1px solid #000; padding: 4px; text-align: left; }
    input { width: 100%; border: none; text-align: right; }
    #modalPrinter {
      display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      background:white; padding:20px; border:1px solid #000; z-index:9999;
    }
  </style>
</head>
<body>

<label><strong>Tanggal:</strong></label>
<input type="date" id="tanggal1">

<table id="tabel1">
  <thead>
    <tr>
      <th>NO</th><th>TRANSAKSI</th><th>TRX</th><th>JUMLAH</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>POSPAY</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>2</td><td>MILE APP</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>3</td><td>RS 3</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>4</td><td>BEA RS</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>5</td><td>METERAI</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>6</td><td>PANJAR</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>7</td><td>OTOKO</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>8</td><td>PANJAR KEMARIN</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>9</td><td>POSPAY BM</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>10</td><td>MILEAPP BM</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>11</td><td>PANJAR TAMBAHAN</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr>
      <td><strong>12</strong></td><td><strong>TOTAL</strong></td>
      <td><input id="totalTrx1" readonly></td>
      <td><input id="totalJumlah1" readonly></td>
    </tr>
  </tbody>
</table>

<button onclick="pilihPrinter()">üñ® Cetak ke Printer Dot Matrix</button>

<!-- Modal Pilihan Printer -->
<div id="modalPrinter">
  <h3>Pilih Printer:</h3>
  <select id="printerList" style="width:100%; padding:5px;"></select><br><br>
  <button onclick="lanjutCetak()">‚úÖ Cetak</button>
  <button onclick="tutupModal()">‚ùå Batal</button>
</div>

<script>
// ==================== JSPM SETUP =====================
JSPM.JSPrintManager.auto_reconnect = true;

window.onload = function () {
  JSPM.JSPrintManager.start();

  // Tunggu sampai status WebSocket berubah (Open / Closed / Blocked)
  JSPM.JSPrintManager.onStatusChanged = function () {
    if (jspmWSStatus()) {
      // ‚úÖ Baru di sini askUserPermission bisa dimatikan
      JSPM.JSPrintManager.askUserPermission = false;
      console.log("‚úÖ JSPM aktif tanpa popup izin.");
    }
  };
};

// ‚úÖ Cek status WebSocket
function jspmWSStatus() {
  return JSPM.JSPrintManager.websocket_status === JSPM.WSStatus.Open;
}

// ==================== FORMAT ANGKA =====================
function formatRibuan(angka) {
  if (angka === "") return "";
  return Number(angka).toLocaleString("id-ID");
}
function formatTanggalIndo(iso) {
  if (!iso) return "__________";
  const bln = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  const [y,m,d] = iso.split("-");
  return `${d} ${bln[m-1]} ${y}`;
}

// ==================== HITUNG TOTAL =====================
function updateTotal() {
  let totalTrx = 0, totalJumlah = 0;
  document.querySelectorAll(".trx").forEach(inp => {
    let v = inp.value.replace(/\D/g,"");
    if(v) totalTrx += Number(v);
  });
  document.querySelectorAll(".jumlah").forEach(inp => {
    let v = inp.value.replace(/\D/g,"");
    if(v) totalJumlah += Number(v);
  });
  totalTrx1.value = formatRibuan(totalTrx);
  totalJumlah1.value = formatRibuan(totalJumlah);
}
document.querySelectorAll(".trx,.jumlah").forEach(inp => {
  inp.addEventListener("input", () => {
    inp.value = formatRibuan(inp.value.replace(/\D/g,""));
    updateTotal();
  });
});

// ==================== ASCII =====================
function tableToAscii(table) {
  const rows = [...table.querySelectorAll("tr")];
  let data = rows.map(r => [...r.children].map(c => {
    let i = c.querySelector("input");
    return i ? (i.value || "").trim() : c.innerText.trim();
  }));
  let colW = [];
  data.forEach(row => row.forEach((c,i) => colW[i] = Math.max(colW[i] || 0, c.length)));
  let line = "+" + colW.map(w => "-".repeat(w+2)).join("+") + "+";
  let out = [line];
  data.forEach((row,i) => {
    out.push("| " + row.map((c,j)=> c.padEnd(colW[j])).join(" | ") + " |");
    if(i === 0 || i === data.length-1) out.push(line);
  });
  return out.join("\n");
}

// ==================== MODAL PRINTER =====================
async function pilihPrinter() {
  if (!jspmWSStatus()) {
    alert("‚ùå JSPrintManager belum berjalan!\nJalankan aplikasinya (ikon biru di tray).");
    return;
  }
  let printers = await JSPM.JSPrintManager.getPrinters();
  let select = document.getElementById("printerList");
  select.innerHTML = "";
  printers.forEach(p => {
    let o = document.createElement("option");
    o.value = o.textContent = p;
    select.appendChild(o);
  });
  document.getElementById("modalPrinter").style.display = "block";
}
function tutupModal() {
  document.getElementById("modalPrinter").style.display = "none";
}

// ==================== CETAK =====================
async function lanjutCetak() {
  updateTotal();
  let ascii = tableToAscii(document.getElementById("tabel1"));
  let tanggal = formatTanggalIndo(document.getElementById("tanggal1").value);
  let finalText = `TANGGAL: ${tanggal}\n\n${ascii}\n\nTERIMA KASIH\n\n`;

  let printer = document.getElementById("printerList").value;
  if (!printer) return alert("‚ö† Pilih printer terlebih dahulu!");

  let cpj = new JSPM.ClientPrintJob();
  cpj.clientPrinter = new JSPM.InstalledPrinter(printer);
  cpj.files.push(new JSPM.PrintFileText(finalText, JSPM.FileSourceType.InMemory, "pos.txt", 1));
  cpj.sendToClient();

  tutupModal();
}
</script>

</body>
</html>
