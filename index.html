<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Form POS + Cetak Dot Matrix (Final)</title>
  <script src="https://unpkg.com/jsprintmanager"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1cm; }
    table { width: 100%; border-collapse: collapse; font-size: 11pt; }
    th, td { border: 1px solid #000; padding: 4px; text-align: left; }
    input { width: 100%; border: none; text-align: right; }
    #modalPrinter {
      display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      background:white; padding:20px; border:1px solid #000; z-index:9999;
    }
  </style>
</head>
<body>

<label><strong>Tanggal:</strong></label>
<input type="date" id="tanggal1">

<!--<table id="tabel1">
  <thead>
    <tr>
      <th>NO</th><th>TRANSAKSI</th><th>TRX</th><th>JUMLAH</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>POSPAY</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>2</td><td>MILE APP</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>3</td><td>RS 3</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>4</td><td>BEA RS</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>5</td><td>METERAI</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>6</td><td>PANJAR</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>7</td><td>OTOKO</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>8</td><td>PANJAR KEMARIN</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>9</td><td>POSPAY BM</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>10</td><td>MILEAPP BM</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>11</td><td>PANJAR TAMBAHAN</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr>
      <td><strong>12</strong></td><td><strong>TOTAL</strong></td>
      <td><input id="totalTrx1" readonly></td>
      <td><input id="totalJumlah1" readonly></td>
    </tr>
  </tbody>
</table>-->

<table id="tabel1">
  <thead>
    <tr>
      <th>NO</th><th>JENIS</th><th>TRX</th><th>JUMLAH</th>
    </tr>
  </thead>
  <tbody>
  <tr><td colspan="4"><strong>BM</strong></td></tr>
    <tr><td>1</td><td>PANJAR DITAHAN</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>2</td><td>MILEAPP</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>3</td><td>RS-3 (KIRIM)</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>4</td><td>BEA RS-3</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>5</td><td>POSPAY</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>6</td><td>METERAI</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>7</td><td>O-TOKO</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>7</td><td>HUTIP DINKOP</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
	<tr>
      <td colspan="2"><strong>TOTAL BM</strong></td>
      <td><input id="totalTrxBM" readonly></td>
      <td><input id="totalJumlahBM" readonly></td>
    </tr>
	<tr><td colspan="4"><strong>O-LOKET</strong></td></tr>
	<tr><td>8</td><td>PANJAR KERJA</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>9</td><td>MILE APP</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>10</td><td>RS-3 (KIRIM)</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>11</td><td>BEA RS-3</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>12</td><td>POSPAY</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>13</td><td>METERAI</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>14</td><td>O-TOKO</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
    <tr><td>14</td><td>HUTIP DINKOP</td><td><input class="trx"></td><td><input class="jumlah"></td></tr>
  <tr>
      <td colspan="2"><strong>TOTAL OL</strong></td>
      <td><input id="totalTrxOL" readonly></td>
      <td><input id="totalJumlahOL" readonly></td>
    </tr>
	<tr><td colspan="4"></td></tr>
    <tr>
      <td colspan="2"><strong>TOTAL</strong></td>
      <td><input id="totalTrx1" readonly></td>
      <td><input id="totalJumlah1" readonly></td>
    </tr>
  </tbody>
</table>

<button onclick="pilihPrinter()">üñ® Cetak ke Printer Dot Matrix</button>

<!-- Modal Pilihan Printer -->
<div id="modalPrinter">
  <h3>Pilih Printer:</h3>
  <select id="printerList" style="width:100%; padding:5px;"></select><br><br>
  <button onclick="lanjutCetak()">‚úÖ Cetak</button>
  <button onclick="tutupModal()">‚ùå Batal</button>
</div>

<script>
// ==================== JSPM SETUP =====================
JSPM.JSPrintManager.auto_reconnect = true;

window.onload = function () {
  JSPM.JSPrintManager.start();

  // ‚úÖ Set tanggal default = hari ini
  const t = new Date();
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth() + 1).padStart(2, '0');
  const dd = String(t.getDate()).padStart(2, '0');
  document.getElementById("tanggal1").value = `${yyyy}-${mm}-${dd}`;

  // ‚úÖ Hilangkan popup izin
  JSPM.JSPrintManager.onStatusChanged = function () {
    if (jspmWSStatus()) JSPM.JSPrintManager.askUserPermission = false;
  };
};

// ‚úÖ Cek status WebSocket
function jspmWSStatus() {
  return JSPM.JSPrintManager.websocket_status === JSPM.WSStatus.Open;
}

// ==================== FORMAT ANGKA =====================
function formatRibuan(angka) {
  if (!angka) return "";
  return Number(angka).toLocaleString("id-ID");
}
function formatTanggalIndo(iso) {
  if (!iso) return "__________";
  const bln = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  const [y,m,d] = iso.split("-");
  return `${d} ${bln[m-1]} ${y}`;
}

// ==================== HITUNG TOTAL (BM, OL, Total) =====================
function updateTotal() {
  let totalBMtrx = 0, totalBMjumlah = 0;
  let totalOLtrx = 0, totalOLjumlah = 0;
  let hitungOL = false;

  document.querySelectorAll("#tabel1 tbody tr").forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length === 1 && cells[0].innerText.includes("O-LOKET")) hitungOL = true;

    const trx = row.querySelector("input.trx");
    const jumlah = row.querySelector("input.jumlah");
    if (trx && jumlah) {
      const v1 = Number(trx.value.replace(/\D/g,'')) || 0;
      const v2 = Number(jumlah.value.replace(/\D/g,'')) || 0;
      if (!hitungOL) { totalBMtrx += v1; totalBMjumlah += v2; }
      else { totalOLtrx += v1; totalOLjumlah += v2; }
    }
  });

  // Set nilai ke input total bagian
  totalTrxBM.value = formatRibuan(totalBMtrx);
  totalJumlahBM.value = formatRibuan(totalBMjumlah);
  totalTrxOL.value = formatRibuan(totalOLtrx);
  totalJumlahOL.value = formatRibuan(totalOLjumlah);

  // Hitung total akhir
  totalTrx1.value = formatRibuan(totalBMtrx + totalOLtrx);
  totalJumlah1.value = formatRibuan(totalBMjumlah + totalOLjumlah);
}

// Auto format input
document.querySelectorAll(".trx,.jumlah").forEach(inp => {
  inp.addEventListener("input", () => {
    inp.value = formatRibuan(inp.value.replace(/\D/g,""));
    updateTotal();
  });
});

// ==================== ASCII (rapi, angka kanan) =====================
function tableToAscii(table) {
  const rows = [...table.querySelectorAll("tr")];
  let data = rows.map(r => [...r.children].map(c => {
    let i = c.querySelector("input");
    return i ? (i.value || "").trim() : c.innerText.trim();
  }));

  let colW = [];
  data.forEach(row => row.forEach((c,i) => {
    colW[i] = Math.max(colW[i] || 0, c.length);
  }));

  let line = "+" + colW.map(w => "-".repeat(w+2)).join("+") + "+";
  let out = [line];

  data.forEach((row, rowIndex) => {
    let formattedRow = row.map((cell, colIndex) => {
      if (colIndex >= 2) return cell.padStart(colW[colIndex]); // angka kanan
      else return cell.padEnd(colW[colIndex]);                 // teks kiri
    }).join(" | ");
    out.push("| " + formattedRow + " |");
    if (rowIndex === 0 || rowIndex === data.length - 1) out.push(line);
  });

  return out.join("\n");
}

// ==================== MODAL PRINTER =====================
async function pilihPrinter() {
  if (!jspmWSStatus()) return alert("‚ùå JSPrintManager belum berjalan!");

  let printers = await JSPM.JSPrintManager.getPrinters();
  let select = document.getElementById("printerList");
  select.innerHTML = "";
  printers.forEach(p => {
    let o = document.createElement("option");
    o.value = o.textContent = p;
    select.appendChild(o);
  });
  document.getElementById("modalPrinter").style.display = "block";
}
function tutupModal() {
  document.getElementById("modalPrinter").style.display = "none";
}

// ==================== CETAK =====================
async function lanjutCetak() {
  updateTotal();
  let ascii = tableToAscii(document.getElementById("tabel1"));
  let tanggal = formatTanggalIndo(document.getElementById("tanggal1").value);
  let finalText = `TANGGAL: ${tanggal}\n\n${ascii}\n\nTERIMA KASIH\n\n`;

  const printer = document.getElementById("printerList").value;
  if (!printer) return alert("‚ö† Pilih printer dulu!");

  let cpj = new JSPM.ClientPrintJob();
  cpj.clientPrinter = new JSPM.InstalledPrinter(printer);
  cpj.printerCommands = finalText; // ‚úÖ Raw text ke Dot Matrix
  cpj.sendToClient();

  tutupModal();
}
</script>


</body>
</html>
